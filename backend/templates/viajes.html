{% extends "base.html" %}
{% block content %}
    <h1>Viajes Registrados</h1>
    
    <!-- BÚSQUEDA Y FILTROS -->
    <div class="search-container">
        <form method="get" action="/viajes_web" class="search-form">
            <input type="text" name="buscar" placeholder="Buscar por origen o destino..." value="{{buscar}}" style="flex:1; min-width:200px;">
            <select name="filtro_estado" style="padding:10px; border:2px solid #e0e0e0; border-radius:6px;">
                <option value="">Todos los estados</option>
                <option value="pendiente" {% if filtro_estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                <option value="en progreso" {% if filtro_estado == 'en progreso' %}selected{% endif %}>En progreso</option>
                <option value="completado" {% if filtro_estado == 'completado' %}selected{% endif %}>Completado</option>
            </select>
            <button type="submit">Buscar</button>
            <a href="/viajes_web" style="background:#666; color:white; padding:10px 20px; border-radius:6px; text-decoration:none; text-align:center;">Limpiar</a>
        </form>
    </div>
    
    {% if error %}
        <div class="error">{{ error }}</div>
    {% endif %}
    
    <p class="result-count">Se encontraron {{viajes|length}} viajes</p>
    
   <table>
        <tr>
            <th>ID</th>
            <th>Origen</th>
            <th>Destino</th>
            <th>Fecha Salida</th>
            <th>Fecha Estimada</th>
            <th>Conductor</th>
            <th>Estado</th>
            {% if usuario and usuario["rol"] == "admin" %}
                <th>Acciones</th>
            {% endif %}
        </tr>
        {% for v in viajes %}
        <tr>
            <td>{{ v.id_viaje }}</td>
            <td>{{ v.origen }}</td>
            <td>{{ v.destino }}</td>
            <td>{{ v.fecha_salida }}</td>
            <td>{{ v.fecha_estimada if v.fecha_estimada is defined else (v.fecha_estimada or '-') }}</td>
            <td>{{ (v.nombre_conductor ~ ' ' ~ v.apellido_conductor).strip() if v.nombre_conductor else '-' }}</td>
            <td>
                {% if v.estado == 'completado' %}
                    <span style="background:#4CAF50; color:white; padding:5px 10px; border-radius:4px; font-size:0.9em;"> {{ v.estado }}</span>
                {% elif v.estado == 'en progreso' %}
                    <span style="background:#2196F3; color:white; padding:5px 10px; border-radius:4px; font-size:0.9em;"> {{ v.estado }}</span>
                {% else %}
                    <span style="background:#FF9800; color:white; padding:5px 10px; border-radius:4px; font-size:0.9em;"> {{ v.estado }}</span>
                {% endif %}
            </td>
            {% if usuario and usuario["rol"] == "admin" %}
                <td>
                    <a href="/viajes_edit/{{v.id_viaje}}" style="color:#336699; margin-right:10px;">Editar</a>
                    <a href="/viajes_delete/{{v.id_viaje}}" onclick="return confirm('¿Eliminar?');" class="delete-btn">Eliminar</a>
                </td>
            {% endif %}
        </tr>
        {% endfor %}
    </table>
    <!-- formulario creación: mostrar select de conductores -->
    {% if usuario and usuario["rol"] in ["admin","logistica"] %}
    <h2 style="text-align:center;">Agregar Viaje</h2>
    <form method="post" action="/viajes_create">
        <input type="text" name="origen" placeholder="Origen (ej: CDMX)" required minlength="2" maxlength="50">
        <input type="text" name="destino" placeholder="Destino (ej: Puebla)" required minlength="2" maxlength="50">
        <input type="date" name="fecha_salida" required>
        <input type="date" name="fecha_estimada" placeholder="Fecha estimada (opcional)">
        <select name="id_conductor">
            <option value="">Asignar conductor (opcional)</option>
            {% for c in conductores_list %}
                <option value="{{ c.id_conductor }}">{{ c.nombre }} {{ c.apellido }}</option>
            {% endfor %}
        </select>
        <select name="estado" required>
            <option value="">Seleccionar estado</option>
            <option value="pendiente">Pendiente</option>
            <option value="en progreso">En progreso</option>
            <option value="completado">Completado</option>
            <option value="cancelado">Cancelado</option>
        </select>
        <button type="submit">Agregar Viaje</button>
    </form>
    {% endif %}
{% endblock %}
