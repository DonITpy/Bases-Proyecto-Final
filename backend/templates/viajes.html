{# Vista de Viajes: listado con búsqueda/filtro y creación/edición según rol (admin/logística).
    Extiende de base.html para estilos globales y navegación. #}
{% extends "base.html" %}
{% block content %}
    <h1>Viajes Registrados</h1>
    
    <!-- BÚSQUEDA Y FILTROS -->
    <div class="search-container">
        <form method="get" action="/viajes_web" class="search-form">
            <input type="text" name="buscar" placeholder="Buscar por origen o destino..." value="{{buscar}}" style="flex:1; min-width:200px;">
            <select name="filtro_estado" style="padding:10px; border:2px solid #e0e0e0; border-radius:6px;">
                <option value="">Todos los estados</option>
                <option value="pendiente" {% if filtro_estado == 'pendiente' %}selected{% endif %}>Pendiente</option>
                <option value="en progreso" {% if filtro_estado == 'en progreso' %}selected{% endif %}>En progreso</option>
                <option value="completado" {% if filtro_estado == 'completado' %}selected{% endif %}>Completado</option>
            </select>
            <button type="submit">Buscar</button>
            <a href="/viajes_web" style="background:#666; color:white; padding:10px 20px; border-radius:6px; text-decoration:none; text-align:center;">Limpiar</a>
        </form>
    </div>
    
    {% if error %}
        <div class="error">{{ error }}</div>
    {% endif %}
    
    <p style="text-align:center; color:#666;">Se encontraron {{viajes|length}} viajes</p>
    
    <table>
        <tr>
            <th>ID</th>
            <th>Origen</th>
            <th>Destino</th>
            <th>Fecha Salida</th>
            <th>Fecha Estimada</th>
            <th>Conductor</th>
            <th>Estado</th>
            {% if usuario and usuario["rol"] in ["admin", "logistica"] %}
                <th>Acciones</th>
            {% endif %}
        </tr>
        {% for v in viajes %}
        <tr>
            <td>{{ v.id_viaje }}</td>
            <td>{{ v.origen }}</td>
            <td>{{ v.destino }}</td>
            <td>{{ v.fecha_salida }}</td>
            <td>{{ v.fecha_estimada if v.fecha_estimada is defined else (v.fecha_estimada or '-') }}</td>
            <td>{{ (v.nombre_conductor ~ ' ' ~ v.apellido_conductor).strip() if v.nombre_conductor else '-' }}</td>
            <td>
                {% if v.estado == 'completado' %}
                    <span style="background:#4CAF50; color:white; padding:5px 10px; border-radius:4px; font-size:0.9em;"> {{ v.estado }}</span>
                {% elif v.estado == 'en progreso' %}
                    <span style="background:#2196F3; color:white; padding:5px 10px; border-radius:4px; font-size:0.9em;"> {{ v.estado }}</span>
                {% else %}
                    <span style="background:#FF9800; color:white; padding:5px 10px; border-radius:4px; font-size:0.9em;"> {{ v.estado }}</span>
                {% endif %}
            </td>
            {% if usuario and usuario["rol"] in ["admin", "logistica"] %}
                <td>
                    <a href="/viajes_edit/{{v.id_viaje}}" style="color:#336699; margin-right:10px;">Editar</a>
                    {% if usuario and usuario["rol"] == "admin" %}
                        <a href="/viajes_delete/{{v.id_viaje}}" onclick="return confirm('¿Eliminar?');" class="delete-btn">Eliminar</a>
                    {% endif %}
                </td>
            {% endif %}
        </tr>
        {% endfor %}
    </table>
    
    {% if usuario and usuario["rol"] in ["admin","logistica"] %}
    <h2 style="text-align:center;">Agregar Viaje</h2>
    <form method="post" action="/viajes_create" id="form-viaje">
        <input type="text" name="origen" placeholder="Origen (ej: CDMX)" required minlength="2" maxlength="50">
        <input type="text" name="destino" placeholder="Destino (ej: Puebla)" required minlength="2" maxlength="50">
        <input type="date" name="fecha_salida" required>
        <input type="date" name="fecha_estimada" placeholder="Fecha estimada (opcional)">
        <select name="id_conductor" id="conductor_select">
            <option value="">Asignar conductor (opcional)</option>
            {% for c in conductores_list %}
                <option value="{{ c.id_conductor }}">{{ c.nombre }} {{ c.apellido }}</option>
            {% endfor %}
        </select>
        <select name="id_vehiculo" id="vehiculo_select">
            <option value="">Asignar vehículo (opcional)</option>
            {% for v in vehiculos_list %}
                <option value="{{ v.id_vehiculo }}" data-conductor="{{ v.id_conductor or '' }}">{{ v.matricula }} - {{ v.modelo }}</option>
            {% endfor %}
        </select>
        <select name="estado" required>
            <option value="">Seleccionar estado</option>
            <option value="pendiente">Pendiente</option>
            <option value="en progreso">En progreso</option>
            <option value="completado">Completado</option>
            <option value="cancelado">Cancelado</option>
        </select>
        <button type="submit">Agregar Viaje</button>
    </form>
    
    <script>
        // Script para filtrar vehículos según el conductor seleccionado
        const conductorSelect = document.getElementById('conductor_select');
        const vehiculoSelect = document.getElementById('vehiculo_select');
        const todasOpciones = Array.from(vehiculoSelect.options);
        
        conductorSelect.addEventListener('change', function() {
            const conductorId = this.value;
            
            // Limpiar el select de vehículos
            vehiculoSelect.innerHTML = '<option value="">Asignar vehículo (opcional)</option>';
            
            if (conductorId) {
                // Filtrar y mostrar solo vehículos del conductor seleccionado
                const vehiculosFiltrados = todasOpciones.filter(option => {
                    return option.value === '' || option.getAttribute('data-conductor') === conductorId;
                });
                
                vehiculosFiltrados.forEach(option => {
                    vehiculoSelect.appendChild(option.cloneNode(true));
                });
                
                if (vehiculoSelect.options.length === 1) {
                    // Si no hay vehículos para este conductor, mostrar mensaje
                    const optionMsg = document.createElement('option');
                    optionMsg.value = '';
                    optionMsg.textContent = 'Este conductor no tiene vehículos asignados';
                    optionMsg.disabled = true;
                    vehiculoSelect.appendChild(optionMsg);
                }
            } else {
                // Si no hay conductor seleccionado, mostrar todos los vehículos
                todasOpciones.forEach(option => {
                    vehiculoSelect.appendChild(option.cloneNode(true));
                });
            }
        });
    </script>
    {% endif %}
{% endblock %}